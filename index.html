<!DOCTYPE html>
<html>
<head>
    <title>Office Attendance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding: 40px 20px; background: #f4f7f6; }
        #app { display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        input { padding: 15px; width: 85%; margin: 20px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        .btn { padding: 20px; width: 100%; color: white; border: none; border-radius: 10px; font-size: 18px; margin: 10px 0; cursor: pointer; font-weight: bold; }
        .login { background: #27ae60; } .logout { background: #e67e22; }
        #msg { color: #c0392b; font-weight: bold; margin-top: 15px; }
    </style>
</head>
<body>
    <div id="app">
        <h2>Attendance Portal</h2>
        <input type="text" id="name" placeholder="Enter Your Full Name">
        <button id="loginBtn" class="btn login" onclick="send('LOGIN')">CLOCK IN</button>
        <button id="logoutBtn" class="btn logout" onclick="send('LOGOUT')">CLOCK OUT</button>
        <p id="msg"></p>
    </div>

    <script>
        const GOOGLE_URL = "https://script.google.com/macros/s/AKfycbxD7XvvxqDVYsOG115VNCldV064DwXn4M_miwRSzS-fLnLry9me6yDk2K0_ymIo81WRCA/exec";

        window.onload = () => {
            const params = new URLSearchParams(window.location.search);
            const received = params.get('auth');
            const now = Math.floor(Date.now() / 30000);
            const token1 = btoa(now).substring(0,8);
            const token2 = btoa(now - 1).substring(0,8);

            if (received === token1 || received === token2) {
                document.getElementById('app').style.display = 'block';
                document.getElementById('name').value = localStorage.getItem('staffName') || '';
            } else {
                document.body.innerHTML = "<h2 style='color:red;'>❌ Expired Session.<br>Please scan the live QR again.</h2>";
            }
        };

        async function send(type) {
            const name = document.getElementById('name').value;
            if(!name) return alert("Please enter your name");
            localStorage.setItem('staffName', name);

            document.getElementById('msg').innerText = "Processing... Please wait.";
            
            try {
                const response = await fetch(GOOGLE_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ name: name, type: type }) 
                });
                const result = await response.text();

                if (result === "ALREADY_EXISTS") {
                    document.getElementById('msg').innerText = "❌ You have already logged in today!";
                } else {
                    document.body.innerHTML = `<h2 style='color:green;'>✅ ${type} Successful!<br>Goodbye, ${name}.</h2>`;
                }
            } catch (e) {
                alert("Connection Error. Try again.");
            }
        }
    </script>
</body>
</html>
